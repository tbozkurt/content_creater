<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Etkinlik Arayüz</title>
    <script src="/libs/jquery/dist/jquery.js"></script>
    <script src="/libs/howler/dist/howler.core.min.js"></script>
    <script src="/libs/konva/konva.js"></script>

    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/create.js"></script>
    <script src="/assets/js/export.js"></script>
    <script src="/assets/js/align.js"></script>
    <script src="/assets/js/player.js"></script>
    <script src="/assets/js/gsap.min.js"></script>
    <script src="/assets/js/Draggable.min.js"></script>
    <link rel="stylesheet" href="/assets/css/ide.css">
    <link rel="stylesheet" href="/assets/css/player.css">
</head>
<body>
<div class="WorkView" id="scope_TopMenu">
    <div>
        <div class="topMenuEmpty">&nbsp;</div>
    </div>

    <div class="AlignMain">
        <div class="TopIconBox" id="createRect"><img src="assets/img/create_rect.png"></div>
        <div class="TopIconBox image-upload">
            <form id="uploadImageForm" enctype="multipart/form-data">
                <label for="file_input" style="cursor: pointer">
                    <img src="assets/img/create_img.png"/>
                </label>

                <input style="display: none" id="file_input" name="uploadImage" type="file" multiple/>
            </form>
        </div>

        <div class="TopIconBox" id="createText"><img src="assets/img/create_text.png"></div>
    </div>

    <div style="display: flex">
        <div class="topMenuBtn" id="save" style="border-right: 1px solid #000000">Kaydet</div>
        <div class="topMenuBtn" id="export">Önizleme</div>
    </div>
</div>

<div id="scope_Canvas"></div>

<div class="WorkSpaces WorkView WorkSpace_Layer" id="scope_LeftWorkSpace" style="left:0; border-right:2px solid">
    <div class="WorkSpaces_Header">&#8627; Layer</div>
    <div id="LayerMain">
        <div class="SR_container2"></div>
    </div>
</div>

<div class="WorkSpaces WorkView" id="scope_RightWorkSpace">

    <div class="WorkSpaces_Group">
        <div class="WorkSpaces_Header">&#8627; Position And Size </div>
        <div class="Properties">
            <div class="Properties_column">
                <div class="Properties_box">
                    <div class="Properties_name">W</div>
                    <input type="number" class="Properties_input" tabindex="3" id="Properties_Width">
                </div>

                <div class="Properties_box">
                    <div class="Properties_name">X</div>
                    <input type="number" class="Properties_input" tabindex="1" id="Properties_Left">
                </div>
            </div>

            <div class="Properties_column">
                <div class="Properties_box">
                    <div class="Properties_name">H</div>
                    <input type="number" class="Properties_input" tabindex="4" id="Properties_Height">
                </div>

                <div class="Properties_box addSpace">
                    <div class="Properties_name">Y</div>
                    <input type="number" class="Properties_input" tabindex="2" id="Properties_Top">
                </div>
            </div>
        </div>
    </div>

    <div class="WorkSpaces_Group">
        <div class="WorkSpaces_Topic">&#8627; Scale</div>
<!--

        <div class="Properties_column addSpace">
            <div class="Properties_box">
                <div class="Properties_name">%</div>
                <input style="width: 123px" type="number" class="Properties_input" id="Properties_ScaleW" tabindex="5">
            </div>
        </div>

-->

        <div class="Properties_column">
            <div class="Properties_box">
                <div class="Properties_name">W</div>
                <input type="number" class="Properties_input" id="Properties_ScaleW">
            </div>

            <div class="Properties_box">
                <div class="Properties_name">H</div>
                <input type="number" class="Properties_input" id="Properties_ScaleH">
            </div>
        </div>

        <div class="addSpace">
            <input type="checkbox" id="ratioCheck" checked>
            <label for="ratioCheck">Constrain ratio</label><br>
        </div>

    </div>

    <div class="WorkSpaces_Group">
        <div class="WorkSpaces_Header">&#8627; Align Object</div>
        <div class="AlignMain">
            <div class="AlignBox" id="align_Left"><img src="assets/img/leftY.svg"></div>
            <div class="AlignBox" id="align_HorizontalCenter"><img src="assets/img/centerY.svg"></div>
            <div class="AlignBox" id="align_Right"><img src="assets/img/rightY.svg"></div>
        </div>
        <div class="AlignMain">
            <div class="AlignBox" id="align_Top"><img src="assets/img/upX.svg"></div>
            <div class="AlignBox" id="align_VerticalCenter"><img src="assets/img/centerX.svg"></div>
            <div class="AlignBox" id="align_Bottom"><img src="assets/img/downX.svg"></div>
        </div>
        <div class="AlignMain">
            <div class="AlignBox" id="align_SpaceHorizontal"><img src="assets/img/spaceX.svg"></div>
            <div class="AlignBox" id="align_SpaceVertical"><img src="assets/img/spaceY.svg"></div>
            <div class="AlignBox" id="align_ScaleAuto"><img src="assets/img/stagescale.svg"></div>
        </div>
        <div class="AlignMain">
            <div class="AlignBox" id="align_CenterStage"><img src="assets/img/stageCenter.svg"></div>
        </div>
    </div>

<!--    <div class="WorkSpaces_Group WorkSpace_Preview">
        <div class="WorkSpaces_Header">&#8627; Preview</div>
        <div class="AlignMain" style="width: 150px">
            <div class="AlignBox" id="save"><img src="assets/img/save.png"></div>
            <div class="AlignBox" id="export"><img src="assets/img/preview.png"></div>
        </div>
    </div>-->

    <div class="WorkSpaces_Group addSpace WorkSpace_SpecialObjects">
        <div class="WorkSpaces_Header">&#8627; Content Objects </div>
        <div class="AlignMain">
            <div class="AlignBox" id="createSelect"><img src="assets/img/cselect.png"></div>
            <div class="AlignBox" id="createPopup"><img src="assets/img/createPopup.png"></div>
            <div class="AlignBox" id="createControl"><img src="assets/img/createbtn.png"></div>
        </div>
        <div class="AlignMain">
            <div class="AlignBox" id="createURL"><img src="assets/img/createurl.png"></div>
        </div>
    </div>

    <div class="WorkSpaces_Group addSpace WorkSpace_Identity">
        <div class="WorkSpaces_Header">&#8627; Identity </div>

        <div class="WorkSpaces_SelectContainer">
            <div class="altHead">ID:</div>
            <input type="text" class="elementInput" id="identity_elementID">
            <div class="altHead">Class:</div>
            <input type="text" class="elementInput" id="identity_elementClass">
            <table id="identity_table"></table>

            <div class="Identity_AddParamBtn">
                <img src="assets/img/addparam.png" id="identity_tableAddBtn" class="paramBtn_icon"/>
            </div>

        </div>
    </div>

    <div class="WorkSpaces_Group addSpace WorkSpace_RightAnswer">
        <div class="WorkSpaces_Header">&#8627; Right Answer </div>
        <div class="WorkSpaces_SelectContainer">
            <select id="rightAnswer" tabindex="5"></select>
        </div>
    </div>

    <div class="WorkSpaces_Group addSpace WorkSpace_ColorPicker">
        <div class="WorkSpaces_Header">&#8627; Color Picker</div>
        <input type="color" id="colorPicker" name="head" value="#ff0000" />
    </div>

<!--
    <div id="omg" style="width:50px; height:50px;background-color: #00796b"></div>
    <div id="omg2" style="width:50px; height:50px;background-color: darkred"></div>
-->
</div>

<div id="welcome_main">
    <div class="welcome_window">
        <div class="welcome_windowTitle">Okulistik Content Creater</div>

        <div class="welcome_file" id="welcome_step1">
            <div id="welcome_savedFileList"></div>
        </div>

        <div class="welcome_file" id="welcome_step2">
            <div id="welcome_sceneTypeList"></div>
        </div>

        <div id="welcome_closeInput">
            <hr>
            <div class="welcome_newFileContainer">
                <input placeholder="Content Name" autocomplete="off" type="text" id="addFileInput">
                <div class="addFileBtn" id="welcome_newFileBtn">
                    <img src="/assets/img/newFile.png" alt="">
                </div>
            </div>
        </div>

    </div>
</div>

<div id="scope_saved">Kaydedildi!</div>

<div class="WorkView WorkSpace_Scene" id="scope_Scene">
    <div class="Scene_addContainer">
        <img id="Scene_addButon" src="assets/img/plus.png" alt="">
        <div id="SR_Scene_Main">
            <div class="SR_Scene_Container"></div>
        </div>
    </div>
    <div id="Slide_fileName"></div>
</div>

<div class="previewMain">
    <div id="previewContent">
        <div id="previewClose">Preview Close</div>
        <div id="Player_Container"></div>
    </div>
</div>

<script>
    var IDE = {
        stage:{width: 1380, height: 820, container: "scope_Canvas", bg:"#404040"},
        layer:{x:50, y:50, width:1280, height: 720},
        text:{write: false, leftSpace: 152, topSpace: 37},
        sceneTypes:[["Çoktan Seçmeli", "CS"], ["Boş Belge", "EMPTY"]],
        activeLayer: null,
        selectedLayers:[],
        selected: false,
        scope: "",
        propValues:{},
        tranforming: false,
        sceneLayer: null,
        editLayer: null,
        sceneSelect: null,
        editSelect: null,
        copy: null,
        sceneUnique: null,
        saveInterval:null,
        workSpace:{
            scope_Canvas: document.querySelector("#scope_Canvas"),
            scope_LeftWorkSpace: document.querySelector("#scope_LeftWorkSpace"),
            scope_RightWorkSpace: document.querySelector("#scope_RightWorkSpace"),
            scope_Scene: document.querySelector("#scope_Scene"),

            previewMain: document.querySelector(".previewMain"),
            previewClose: document.querySelector("#previewClose"),
            playerContainer: document.querySelector("#Player_Container"),

            leftInput: document.querySelector("#Properties_Left"),
            topInput: document.querySelector("#Properties_Top"),
            widthInput: document.querySelector("#Properties_Width"),
            heightInput: document.querySelector("#Properties_Height"),
            scaleWInput: document.querySelector("#Properties_ScaleW"),
            scaleHInput: document.querySelector("#Properties_ScaleH"),

            createText: document.querySelector("#createText"),
            createRect: document.querySelector("#createRect"),
            createSelect: document.querySelector("#createSelect"),
            createPopup: document.querySelector("#createPopup"),
            createControl: document.querySelector("#createControl"),
            createURL: document.querySelector("#createURL"),
            uploadImageForm: document.querySelector("#uploadImageForm"),
            colorPicker: document.querySelector("#colorPicker"),

            align_Left: document.querySelector("#align_Left"),
            align_HorizontalCenter: document.querySelector("#align_HorizontalCenter"),
            align_Right: document.querySelector("#align_Right"),
            align_Top: document.querySelector("#align_Top"),
            align_VerticalCenter: document.querySelector("#align_VerticalCenter"),
            align_Bottom: document.querySelector("#align_Bottom"),
            align_SpaceHorizontal: document.querySelector("#align_SpaceHorizontal"),
            align_SpaceVertical: document.querySelector("#align_SpaceVertical"),
            align_ScaleAuto: document.querySelector("#align_ScaleAuto"),
            align_CenterStage: document.querySelector("#align_CenterStage"),

            identity_elementID: document.querySelector("#identity_elementID"),
            identity_elementClass: document.querySelector("#identity_elementClass"),
            identity_table: document.querySelector("#identity_table"),
            identity_tableAddBtn: document.querySelector("#identity_tableAddBtn"),

            rightAnswer: document.querySelector("#rightAnswer"),
            ratioCheck: document.querySelector("#ratioCheck"),
            WorkSpace_Layer: document.querySelector(".WorkSpace_Layer"),
            WorkSpace_SpecialObjects: document.querySelector(".WorkSpace_SpecialObjects"),
            WorkSpace_RightAnswer: document.querySelector(".WorkSpace_RightAnswer"),
            WorkSpace_Scene: document.querySelector(".WorkSpace_Scene"),
            WorkSpace_Preview: document.querySelector(".WorkSpace_Preview"),
            WorkSpace_ColorPicker: document.querySelector(".WorkSpace_ColorPicker"),
            WorkSpace_Identity: document.querySelector(".WorkSpace_Identity")
        },
        welcome:{
            main: document.querySelector("#welcome_main"),
            step1: document.querySelector("#welcome_step1"),
            step2: document.querySelector("#welcome_step2"),
            closeInput: document.querySelector("#welcome_closeInput"),
            savedFileList: document.querySelector("#welcome_savedFileList"),
            sceneTypeList: document.querySelector("#welcome_sceneTypeList"),
            newFileBtn: document.querySelector("#welcome_newFileBtn"),
            addFileInput: document.querySelector("#addFileInput"),
        },
        identity_tableTemplate: `<th class="td1">Key</th><th class="td2">Value</th><th class="td3"></th>`
    }

    var stage = new Konva.Stage(IDE.stage);
    IDE.sceneLayer = new Konva.Layer(IDE.layer);
    IDE.editLayer = new Konva.Layer(IDE.layer);
    var Ruler = new Konva.Layer({width: 1380, height: 820});
    var KonvaBG = new Konva.Layer(IDE.layer);
    IDE.sceneLayer.attrs.layer = "main";
    stage.add(Ruler);
    stage.add(KonvaBG);
    stage.add(IDE.sceneLayer);
    stage.add(IDE.editLayer);

    IDE.editSelect = getSELECT();
    IDE.sceneSelect = getSELECT();
    IDE.editLayer.add(IDE.editSelect);
    IDE.sceneLayer.add(IDE.sceneSelect);
    var SELECT = IDE.sceneSelect;
    IDE.activeLayer = IDE.sceneLayer;

    IDE.editBG = new Konva.Rect({
        x: 0,
        y: 0,
        width: 1280,
        height: 720,
        fill: "rgba(0, 120, 0, 0.5)",
        draggable: false
    });
    IDE.editLayer.add(IDE.editBG).x(1400);

    var imageObj = new Image();
    imageObj.onload = function () {
        var yoda = new Konva.Image({
            x: 0,
            y: 0,
            image: imageObj,
            width: 1380,
            height: 820,
        });

        Ruler.add(yoda);
    };
    imageObj.src = '/assets/img/rulers.png';

    var CREATE = new CREATE();
    var EXPORT = new EXPORT();
    var utils = new utils();
    var ALIGN = new ALIGN();
    var Player;
    var sceneIndex=0;

    var jsonV2 = {
        fileName: "",
        createTime: "",
        slides: []
    };

    function sceneTemplate(){
        return {
            type: "KT_MC_Single",
            rightAnswer: null,
            scene: {},
            all: [],
            stage: {},
            img: [],
            check: [],
            text: []
        }
    }

    function getSELECT(){
        var tempSelect = new Konva.Transformer({
            flipEnabled: false,
            rotateEnabled: false,
            keepRatio: true,
            enabledAnchors: ['bottom-right']
        });

        tempSelect.on("transformstart transform", function(){
            IDE.tranforming = true;
        });

        tempSelect.on("transformend", function(){
            IDE.tranforming = false;
        });

       return tempSelect;
    }

    var changeSelect = {
        objectText: function(tr){
            tr.enabledAnchors(["middle-right"]);
            tr.boundBoxFunc(function (oldBox, newBox) {
                newBox.width = Math.max(30, newBox.width);
                return newBox;
            });
        },

        objectMovieClip: function (tr){
            tr.enabledAnchors(["bottom-right"]);
            tr.boundBoxFunc(null);
        },

        objectImg: function (tr){
            tr.enabledAnchors(["bottom-right"]);
            tr.boundBoxFunc(null);
        },

        objectRect: function (tr){
            tr.enabledAnchors(['top-left', 'top-center', 'top-right', 'middle-right', 'middle-left', 'bottom-left', 'bottom-center', 'bottom-right']);
            tr.boundBoxFunc(null);
        },

        multi: function (tr){
            tr.enabledAnchors([]);
            tr.boundBoxFunc(null);
        }
    }

    function selectItem(temp){
        IDE.selected = true;

        if(temp.shiftKey){
            IDE.selectedLayers.push(temp.layer);
            changeSelect["multi"](SELECT);
        }else{
            if(!IDE.selectedLayers.length){
                IDE.selectedLayers = [temp.layer];
                changeSelect[ temp.layer.Layer.type ](SELECT);
                colorPicker(false);
            }
        }

        SELECT.nodes(IDE.selectedLayers).moveToTop();
        checkIdentity(temp.layer);
        layerBackgroundColor();
    }

    function colorPicker(set){
        if(IDE.selectedLayers.length){
            var currentType = IDE.selectedLayers[0].Layer.type;
            if(set){
                if(currentType==="objectText" || currentType==="objectRect"){
                    IDE.selectedLayers[0].fill(IDE.workSpace.colorPicker.value);
                }
            }else{
                if(currentType==="objectText" || currentType==="objectRect"){
                    IDE.workSpace.colorPicker.value = IDE.selectedLayers[0].fill();
                    IDE.workSpace.WorkSpace_ColorPicker.style.display = "block";
                }else{
                    IDE.workSpace.WorkSpace_ColorPicker.style.display = "none";
                }
            }
        }
    }

    /* Identity */

    function checkIdentity(){
        if(IDE.selectedLayers.length === 1){
            var obj = IDE.selectedLayers[0];
            if(obj.Layer.elementID){
                IDE.workSpace.identity_elementID.value = obj.Layer.elementID;
            }else{
                IDE.workSpace.identity_elementID.value = "";
            }

            if(obj.Layer.class){
                IDE.workSpace.identity_elementClass.value = obj.Layer.class;
            }else{
                IDE.workSpace.identity_elementClass.value = "";
            }

            IDE.workSpace.identity_elementID.style.opacity = 1;
            IDE.workSpace.identity_elementID.removeAttribute("disabled");
            IDE.workSpace.identity_elementClass.style.opacity = 1;
            IDE.workSpace.identity_elementClass.removeAttribute("disabled");

            IDE.workSpace.identity_table.innerHTML = IDE.identity_tableTemplate;
            IDE.addTableParamFNC();
        }else{
            resetIdentity();
        }
    }

    IDE.addTableParamFNC = function(){
        var obj = IDE.selectedLayers[0];
        if(obj.Layer.params){
            var param = [];
            var tableHtml = IDE.identity_tableTemplate;

            for(var prop in obj.Layer.params){
                var idKey = prop+"_key";
                var idVal = prop+"_val";
                var idBtn = prop+"_btn";

                tableHtml += `<tr>
                        <td><input type="text" class="input1 tableInput" id="${idKey}" value="${prop}"></td>
                        <td><input type="text" class="td2 tableInput input2" id="${idVal}" value="${obj.Layer.params[prop]}"></td>
                        <td class="td3"><img src="assets/img/removeparam.png" id="${idBtn}" class="paramBtn_icon" alt=""/></td>
                    </tr>`;

                param.push({prop, idKey, idVal, idBtn});
            }

            IDE.workSpace.identity_table.innerHTML = tableHtml;

            param.map(function(e){
                var prop = e.prop;
                document.querySelector("#"+ e.idKey).addEventListener("input", function(){
                    var oldVal = IDE.selectedLayers[0].Layer.params[prop];
                    delete IDE.selectedLayers[0].Layer.params[prop];
                    prop = this.value;
                    IDE.selectedLayers[0].Layer.params[prop] = oldVal;
                    console.log(IDE.selectedLayers[0].Layer.params);
                });

                document.querySelector("#"+ e.idVal).addEventListener("input", function(){
                    IDE.selectedLayers[0].Layer.params[prop] = this.value;
                    console.log(IDE.selectedLayers[0].Layer.params);
                });

                document.querySelector("#"+ e.idBtn).addEventListener("click", function(){
                    console.log(IDE.selectedLayers[0].Layer);
                    delete IDE.selectedLayers[0].Layer.params[prop];
                    IDE.addTableParamFNC();
                });
            });
        }
    }

    function resetIdentity(){
        IDE.workSpace.identity_elementID.value = "";
        IDE.workSpace.identity_elementID.style.opacity = 0.6;
        IDE.workSpace.identity_elementID.setAttribute("disabled", "disabled");
        IDE.workSpace.identity_elementClass.value = "";
        IDE.workSpace.identity_elementClass.style.opacity = 0.6;
        IDE.workSpace.identity_elementClass.setAttribute("disabled", "disabled");
        IDE.workSpace.identity_table.innerHTML = IDE.identity_tableTemplate;
    }


    IDE.workSpace.identity_elementID.addEventListener("input", function(){
        if(IDE.selectedLayers.length === 1){
            IDE.selectedLayers[0].Layer.elementID = IDE.workSpace.identity_elementID.value;
        }
    });

    IDE.workSpace.identity_elementID.addEventListener("keydown", function(e){
        if(e.which===13 || e.keyCode===13){
            this.blur();
        }
    });

    IDE.workSpace.identity_elementID.addEventListener("blur", function(){
        console.log("Blur oldu");
        IDE.selectedLayers[0].Layer.layerNameNormal.innerHTML = IDE.workSpace.identity_elementID.value;
    });

    IDE.workSpace.identity_elementClass.addEventListener("input", function(){
        if(IDE.selectedLayers.length === 1){
            IDE.selectedLayers[0].Layer.class = IDE.workSpace.identity_elementClass.value;
        }
    });

    IDE.workSpace.identity_elementClass.addEventListener("keydown", function(e){
        if(e.which===13 || e.keyCode===13){
            this.blur();
        }
    });


    identity_tableAddBtn.addEventListener("click", function(){
        if(IDE.selectedLayers.length === 1){
            if(!IDE.selectedLayers[0].Layer.params){
                IDE.selectedLayers[0].Layer.params = {}
            }

            IDE.selectedLayers[0].Layer.params["New"] = "";
            IDE.addTableParamFNC();
        }
    });

    /* Identity */

    var layerBackgroundColor = function(){
        var localEX = utils.getLayers();
        localEX.forEach(function(tempLayer){
            if(tempLayer.Layer.main){
                tempLayer.Layer.main.style.backgroundColor = "#323232";
            }
        });

        IDE.selectedLayers.map(function(tempLayer){
            if(tempLayer.Layer.main){
                tempLayer.Layer.main.style.backgroundColor = "#35618f";
            }
        });
    }

    function deSelect(){
        IDE.selectedLayers = [];
        layerBackgroundColor();
        SELECT.nodes(IDE.selectedLayers);
        getProp(false);
        resetIdentity();
    }

    /* Layer Tüm Objeleri Silme */
    function layerDeleteAll(){
        LayerSR.resetSystem();
        var localEX = utils.getLayers();
        localEX.map(function(i){
            i.destroy();
        });

        deSelect();
    }

    function addObjects(kids, container, addLayer){
        kids.map(function(e){
            var layer = { ...e.Layer };
            delete e.Layer;
            if(layer.type === "objectRect"){
                CREATE.rectFNC({
                    properties: e,
                    container: container,
                    layer: layer,
                    addLayer: addLayer
                });
            }else if(layer.type === "objectCircle"){
                CREATE.circlesFNC({
                    properties: e,
                    container: container,
                    layer: layer,
                    addLayer: addLayer
                });
            }else if(layer.type === "objectImg"){
                CREATE.imgFNC({
                    properties: e,
                    container: container,
                    layer: layer,
                    uploadImg: null,
                    addLayer: addLayer
                });
            }else if(layer.type === "objectText"){
                CREATE.textFNC({
                    properties: e,
                    container: container,
                    layer: layer,
                    addLayer: addLayer
                });
            }else if(layer.type === "objectMovieClip"){
                var movieClip = CREATE.movieClipFNC({
                    properties: e,
                    container: container,
                    layer: layer
                });

                addObjects(e.Kids, movieClip, false);
                Arayuz_addLayer(movieClip);
            }
        });
    }


    /* Sahne Seçme */
    function sceneSelect(request){
        sceneIndex = request;
        layerDeleteAll();
        addObjects(jsonV2.slides[sceneIndex].all, IDE.sceneLayer, true);
        addHistory();
        importTypeSettings();
        searchSingleUseObject();

        document.querySelectorAll(".SR_Scene_Drag").forEach(function(btn){
            btn.style.backgroundColor = "#666666";
        });

        IDE.sceneUnique = jsonV2.slides[sceneIndex].unique;
        document.querySelector("#"+IDE.sceneUnique).style.backgroundColor = "darkgreen";
    }

    function autoSceneSave(){
        var saveData = false;
        if(jsonV2.slides.length){
            saveData = true;
        }

        if(saveData){
            EXPORT.convertJson();
            console.log("Current Scene Save: [OK]");
        }
    }

    function importTypeSettings(){
        if(jsonV2.slides[sceneIndex].rightAnswer){
            IDE.workSpace.rightAnswer.value = jsonV2.slides[sceneIndex].rightAnswer;
        }
    }


    /* Yeni Sahne Ekleme */
    function sceneAddNewScene(template){
        jsonV2.slides.push(template);
        var lastIndex = (jsonV2.slides.length-1);
        sceneAddNavigationBtn(lastIndex);
        sceneSelect(lastIndex);
    }

    /* Sahne Silme */
    function sceneDelete(){
        jsonV2.slides.splice(sceneIndex, 1);

        if(jsonV2.slides.length){
            sceneSelect(0);
        }else{
            layerDeleteAll();
            showSceneType();
        }
    }

    /* Sahne Sıralama Değiştirme */
    function sceneChangeSort(list, sceneID, newList){
        var slidesClone = jsonV2.slides.slice();
        jsonV2.slides=[];

        newList.map(function(x, index){
            slidesClone.map(function(y){
                if(x[1] === y.unique){
                    jsonV2.slides.push(y);
                }

                if(x[1] === IDE.sceneUnique){
                    sceneIndex = index;
                }
            });
        });
    }

    /* Sahne Navigasyon Buton Ekleme */
    function sceneAddNavigationBtn(id, name){
        if(!name){name="s"+id}
        jsonV2.slides[id].name = name;

        var unique = utils.getRandomName();
        if(jsonV2.slides[id].unique){
            unique = jsonV2.slides[id].unique;
        }else{
            jsonV2.slides[id].unique = unique;
        }

        SceneSR.clicked(`<div class="SR_Scene_Drag" id="${unique}">${name}</div>`, unique);
        document.querySelector("#"+unique).addEventListener("click", function(){
            jsonV2.slides.map(function(scene, index){
                if(scene.unique === unique){
                    autoSceneSave();
                    sceneSelect(index);
                }
            })
        });
    }


    function addSceneTypeBtnHTML(filename, id){
        var htmlID = "new_"+id.toLowerCase();

        let html = `<div class="welcome_fileBtn_Part">
                        <img class="welcome_fileIcon" src="/assets/img/createscene.png" alt="file">
                        <div>${filename}</div>
                    </div>`;

        let div = utils.addDOM({className:"welcome_fileBtn", id:htmlID, innerHTML:html});
        IDE.welcome.sceneTypeList.appendChild(div);

        document.querySelector("#"+ htmlID).addEventListener("click", function(e){
            var template = sceneTemplate();
            template.type = id.toLowerCase();
            console.log(template);
            sceneAddNewScene(template);
            IDE.welcome.main.style.display = "none";
        });
    }

    /* File System */
    function addSavedFileBtn(filename, date){
        let html = `<div class="welcome_fileBtn_Part">
                        <img class="welcome_fileIcon" src="/assets/img/editFile.png" alt="file">
                        <div>${filename}</div>
                    </div>
                    <div class="welcome_fileBtn_Part">
                        <div class="welcome_dateBox">${date}</div>
                        <div id="z_${filename}" class="welcome_fileBtn_smallBtn">
                            <img class="welcome_fileBtn_icon" src="/assets/img/zip.png" alt="file">
                        </div>
                        <div id="d_${filename}" class="welcome_fileBtn_smallBtn">
                            <img class="welcome_fileBtn_icon" src="/assets/img/delete.png" alt="file">
                        </div>
                        <div id="p_${filename}" class="welcome_fileBtn_smallBtn">
                            <img class="welcome_fileBtn_icon" src="/assets/img/preview.png" alt="file">
                        </div>
                        <div id="o_${filename}" class="welcome_fileBtn_smallBtn">
                            <img class="welcome_fileBtn_icon" src="/assets/img/optic.png" alt="file">
                        </div>
                    </div>`;
        let div = utils.addDOM({className:"welcome_fileBtn", id:"f_"+ filename, innerHTML:html});
        IDE.welcome.savedFileList.appendChild(div);

        document.querySelector("#f_"+ filename).addEventListener("click", function(e){
            selectFileAjax(filename);
            IDE.welcome.main.style.display = "none";
            IDE.welcome.step1.style.display = "none";
            IDE.welcome.step2.style.marginBottom = "50px";
            IDE.welcome.closeInput.style.display = "none";
        });

        document.querySelector("#z_"+ filename).addEventListener("click", function(e){
            zipContentAjax(filename);
            e.stopPropagation();
        });

        document.querySelector("#d_"+ filename).addEventListener("click", function(e){
            deleteFolderAjax(filename);
            e.stopPropagation();
        });

        document.querySelector("#p_"+ filename).addEventListener("click", function(e){
            window.open("/player/?file="+ filename +"&mode=normal");
            e.stopPropagation();
        });

        document.querySelector("#o_"+ filename).addEventListener("click", function(e){
            window.open("/player/?file="+ filename +"&mode=optic");
            e.stopPropagation();
        });
    }

    function showSceneType(){
        IDE.welcome.main.style.display = "flex";
        IDE.welcome.step2.style.display = "block";
    }


    function addSceneAddButon(){
        document.querySelector("#Scene_addButon").addEventListener("click", function(){
            autoSceneSave();
            showSceneType();
        });

        addStageBG();
        document.querySelector("#Slide_fileName").innerHTML = jsonV2.fileName;
    }

    /* Ajax */
    function newFileAjax(json){
        var data = {data: JSON.stringify(json)};
        $.ajax({url: "/createNewFile", data, success: newFileParse, type: "POST", error: ajaxError});
    }

    function newFileParse(data){
        console.log(data);
        IDE.files = data.files;

        addSceneAddButon();
    }

    function selectFileAjax(file){
        var data = {file};
        $.ajax({url: "/selectFile", data, success: selectFileParse, type: "POST", error: ajaxError});
    }

    function selectFileParse(data){
        if(data.success){
            IDE.files = data.FILE.files;
            jsonV2 = data.FILE.files.data;

            if(jsonV2.slides.length){
                jsonV2.slides.map(function(o, i){
                    sceneAddNavigationBtn(i, o.name);
                });

                sceneSelect(0);
            }else{
                showSceneType();
            }


            addSceneAddButon();
        }else{
            alert("dosya bulunamadı");
        }
    }

    function saveDataAjax(json){
        var data = {data: JSON.stringify(json)};
        $.ajax({url: "/saveData", data, success: saveDataParse, type: "POST", error: ajaxError});
    }

    function saveDataParse(data){
        console.log("saveDataParse", data);
    }

    function deleteFolderAjax(file){
        var data = {file};
        console.log(data);
        $.ajax({url: "/deleteFolder", data, success: deleteFolderParse, type: "POST", error: ajaxError});
    }

    function deleteFolderParse(data){
        console.log("deleted Content Parse:", data);
        getFileListParse(data);
    }

    function deleteFileAjax(file){
        var data = {file};
        $.ajax({url: "/deleteFile", data, success: deleteFileParse, type: "POST", error: ajaxError});
    }

    function deleteFileParse(data){
        console.log("deleted File Parse:", data);
    }

    function zipContentAjax(file){
        var data = {file};
        $.ajax({url: "/getZip", data, success: zipContentParse, type: "POST", error: ajaxError});
    }

    function zipContentParse(data){
        console.log("zipContentParse", data);
        if(data.success){
            var path = "/files/"+ data.content.files.activeFile +".zip";
            fetch(path)
                .then(function (resp) {
                    if(resp.ok){
                        return resp.blob()
                    }
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = data.content.files.activeFile+".zip";
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    console.log("your file has downloaded!");
                })
                .catch(() => alert("zip dosyası oluşturulurken hata oluştu!"));
        }else{
            alert("zip dosyası hatası!");
        }
    }

    function uploadImageAjax(data){
        $.ajax({url: "/uploadImage", data, success: uploadImageParse, type:"POST", contentType: false, cache:false, processData: false, error: ajaxError});
    }

    function uploadImageParse(data){
        data.map(function(e, i){
            CREATE.imgFNC({
                properties:{
                    x: i*75,
                    y: i*75,
                    scale: {x: 1, y: 1},
                    src: e.path.split("/"+ IDE.files.activeFile +"/")[1],
                    draggable: true
                },
                container: IDE.activeLayer,
                layer:{
                    name: e.filename,
                    type:"objectImg"
                },
                addLayer: true
            });

        });
    }

    function ajaxError(e){console.log(e)}


    function getFileListParse(data){
        var saveList = [];

        for(var p in data.fileList.data){
            saveList.push({fileName: p, createTime: data.fileList.data[p].create});
        }

        saveList.sort(function(a,b){
            return new Date(b.createTime) - new Date(a.createTime);
        });

        IDE.welcome.savedFileList.innerHTML="";

        saveList.map(function(data){
            addSavedFileBtn(data.fileName, data.createTime);
        });
    }

    function addStageBG(){
        CREATE.rectFNC({
            properties:{x: 0, y: 0, width: 1280, height: 720, fill: IDE.stage.bg},
            container: KonvaBG
        });
    }

    IDE.sceneTypes.map(function(e){
        addSceneTypeBtnHTML(e[0], e[1]);
    });

    $.ajax({url: "/getFileList", success: getFileListParse, type: "POST", error: ajaxError});

</script>
<!--<div id="textEditBox" contenteditable="true">gg</div>-->

<script src="/assets/js/sr.js"></script>
<script src="/assets/js/ide.js"></script>
</body>
</html>